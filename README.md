# Terraform

Terraform configuration for the Recrd base infrastructure

## Base infrastructure

These components are not strictly related to any services or it's more convenient to manage them centrally (e.g. ECR repositories).

Resources related to a specific service are kept in the repository of that service. By convention under the `terraform` subdirectory.
See an example in [congo][].

These "satellite" Terraform workspaces are usually depending on one or more "base" workspaces.

[congo]: https://github.com/RecrdGroup/congo/tree/main/terraform

## Developer guide

[You can find the developer guide here](./developer_guide.md)

## Terraform Cloud

Terraform Cloud is being used as a remote state at the moment. Plans are `local`, which means necessary secrets must be supplied locally.

Secrets can be specified at runtime, but it's not convenient. It's possible to export them as environment variables like `TF_VAR_TFE_TOKEN` or add them as HCL variables to `*.auto.tfvars` files which are not tracked.

### Future plans

It's planned to switch to the paid `Team & Governance` tier of Terraform Cloud, which allows us to host our own Terraform agents on Kubernetes eliminating the need for using long-living AWS API keys.

This is required for `remote` plans and triggers between workspaces to allow changes to ripple through the affected downstream workspaces.

Further reading on managing credentials in Terraform Cloud can be found [here][managing_credentials].

[managing_credentials]: https://www.hashicorp.com/blog/managing-credentials-in-terraform-cloud-and-enterprise

## Plan

```shell
cd users
aws-vault exec recrd/admin -- terraform plan
```

## Update process

We need to define how to update:
- providers
- modules

Currently each version is managed inside the workspace.

### AWS provider version 4

In an early phase of the project v4 of the AWS Terraform provider was released.
We opted for using the stable v3, but we need to upgrade to v4 eventually.

[Jira ticket][v4_upgrade]

[v4_upgrade]: https://recrd.atlassian.net/browse/UT-40

## Lock files

Lock files are platform dependent, but can support multiple platforms at once, we need to keep maintaining multiple platforms as long as we run `local` plans on different OSes and architectures.

You only need to do this on new workspaces and when providers are getting updated.

The `.terraform.lock.hcl` are generated by the following process:

```shell
aws-vault exec recrd/admin -- terraform init
rm .terraform.lock.hcl
terraform providers lock -platform=darwin_amd64 -platform=darwin_arm64 -platform=linux_amd64 -platform=windows_amd64
git add .terraform.lock.hcl
```

### Transitive dependencies

Providers required by 3rd party modules are currently not locked in the workspaces.

The Terraform lock files guarantee they are consistent across workstations. When providers are getting updated they are going to be automatically updated too.
If required they can be locked to a specific version during the provider update process.

---

## Links

- [Terraform](https://www.terraform.io/)
- [aws-vault](https://github.com/99designs/aws-vault)
